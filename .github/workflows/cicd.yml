name: CI/CD

on: [pull_request, push]

jobs:
  continous-integration:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Build
        run: docker build -f ./build/package/Dockerfile .
  
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    needs: [continous-integration]
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to EC2
        env:
          PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
        run: |
          echo "$PRIVATE_KEY" > sisconf-go-microservice.pem && chmod 600 sisconf-go-microservice.pem
          ssh -o StrictHostKeyChecking=no -i sisconf-go-microservice.pem ${USER}@${HOST} << 'EOF'
          BRANCH=${{ github.ref_name }}

          if [ -d "sisconf-orders-group-ms" ]; then
            cd sisconf-orders-group-ms
            sudo docker compose -f docker-compose-prod.yml down
          fi

          sudo rm -rf sisconf-orders-group-ms

          git clone --branch ${BRANCH} --single-branch https://github.com/SISCONF/sisconf-orders-group-ms.git
          cd ~/sisconf-orders-group-ms
          touch .env
          cat ~/.env > .env
          sudo docker compose -f docker-compose-prod.yml up -d
          EOF
